<div class="flex gap-6 h-full">
  <!-- Liste des propositions -->
  <div class="flex-1">
    <div class="bg-white rounded-lg shadow">
      <!-- Filtres -->
      <div class="p-6 border-b">
        <div class="flex gap-2 overflow-x-auto">
          <button (click)="setFilter('all')"
                  [class.bg-eduka-orange]="selectedFilter() === 'all'"
                  [class.text-white]="selectedFilter() === 'all'"
                  [class.bg-gray-100]="selectedFilter() !== 'all'"
                  class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap">
            Toutes ({{ getFilterCount('all') }})
          </button>
          <button (click)="setFilter(StatutProposition.EN_ATTENTE)"
                  [class.bg-eduka-orange]="selectedFilter() === StatutProposition.EN_ATTENTE"
                  [class.text-white]="selectedFilter() === StatutProposition.EN_ATTENTE"
                  [class.bg-gray-100]="selectedFilter() !== StatutProposition.EN_ATTENTE"
                  class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap">
            En attente ({{ getFilterCount(StatutProposition.EN_ATTENTE) }})
          </button>
          <button (click)="setFilter(StatutProposition.ACCEPTEE)"
                  [class.bg-eduka-orange]="selectedFilter() === StatutProposition.ACCEPTEE"
                  [class.text-white]="selectedFilter() === StatutProposition.ACCEPTEE"
                  [class.bg-gray-100]="selectedFilter() !== StatutProposition.ACCEPTEE"
                  class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap">
            Accept√©es ({{ getFilterCount(StatutProposition.ACCEPTEE) }})
          </button>
          <button (click)="setFilter(StatutProposition.REFUSEE)"
                  [class.bg-eduka-orange]="selectedFilter() === StatutProposition.REFUSEE"
                  [class.text-white]="selectedFilter() === StatutProposition.REFUSEE"
                  [class.bg-gray-100]="selectedFilter() !== StatutProposition.REFUSEE"
                  class="px-4 py-2 rounded-lg font-medium transition-colors whitespace-nowrap">
            Refus√©es ({{ getFilterCount(StatutProposition.REFUSEE) }})
          </button>
        </div>
      </div>

      <!-- Liste des cartes -->
      <div class="p-6">
        @if (filteredPropositions().length === 0) {
          <div class="text-center py-12">
            <svg class="w-16 h-16 mx-auto text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-gray-500 text-lg">Aucune proposition disponible</p>
          </div>
        } @else {
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            @for (proposition of filteredPropositions(); track proposition.id) {
              <div class="bg-white border rounded-lg p-6 hover:shadow-lg transition-shadow cursor-pointer"
                   (click)="selectProposition(proposition)">
                <!-- Header -->
                <div class="flex items-start justify-between mb-4">
                  <div class="flex items-start gap-3 flex-1">
                    <img [src]="getSchoolLogo(proposition.ecole)" [alt]="proposition.ecole.nom" class="w-12 h-12 bg-gray-100 rounded object-contain p-1" />
                    <div class="flex-1">
                      <h3 class="text-lg font-bold text-gray-800 mb-1">
                        {{ proposition.cours.nom }}
                      </h3>
                      <p class="text-sm text-gray-600">{{ proposition.ecole.nom }}</p>
                    </div>
                  </div>
                  <span class="inline-block px-3 py-1 rounded-full text-xs font-medium border"
                        [ngClass]="getStatutColor(proposition.statut)">
                    {{ getStatutLabel(proposition.statut) }}
                  </span>
                </div>

                <!-- Description -->
                <p class="text-sm text-gray-700 mb-4 line-clamp-2">
                  {{ proposition.description }}
                </p>

                <!-- Infos -->
                <div class="space-y-2 mb-4">
                  @if (proposition.sessions && proposition.sessions.length > 0) {
                    <!-- Affichage pour propositions multi-sessions -->
                    <div class="flex items-center text-sm text-gray-600">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      Du {{ proposition.dateDebut | date:'dd/MM/yyyy':'':'fr-FR' }} au {{ proposition.dateFin | date:'dd/MM/yyyy':'':'fr-FR' }}
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      {{ proposition.sessions.length }} session(s) - {{ proposition.volumeHoraire }}h
                    </div>
                  } @else {
                    <!-- Affichage legacy pour missions sur une journ√©e -->
                    <div class="flex items-center text-sm text-gray-600">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                      {{ proposition.dateDebut | date:'fullDate':'':'fr-FR' }}
                    </div>
                    <div class="flex items-center text-sm text-gray-600">
                      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      {{ proposition.heureDebut }} - {{ proposition.heureFin }}
                    </div>
                  }
                  <div class="flex items-center text-sm text-gray-600">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    {{ proposition.remuneration }}‚Ç¨
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2">
                  @if (hasApplied(proposition)) {
                    <button disabled
                            class="flex-1 px-4 py-2 bg-gray-100 text-gray-500 rounded-lg cursor-not-allowed">
                      ‚úì D√©j√† postul√©
                    </button>
                  } @else if (isExpired(proposition)) {
                    <button disabled
                            class="flex-1 px-4 py-2 bg-gray-100 text-gray-500 rounded-lg cursor-not-allowed">
                      Expir√©e
                    </button>
                  } @else if (proposition.statut === StatutProposition.EN_ATTENTE) {
                    <button (click)="postuler(proposition.id); $event.stopPropagation()"
                            class="flex-1 px-4 py-2 bg-eduka-orange text-white rounded-lg hover:bg-orange-600 transition-colors">
                      Postuler
                    </button>
                  }
                  <button (click)="selectProposition(proposition); $event.stopPropagation()"
                          class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                    D√©tails
                  </button>
                </div>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Sidebar d√©tails proposition -->
  @if (selectedProposition()) {
    <div class="w-96 bg-white rounded-lg shadow-lg p-6 overflow-y-auto">
      <div class="flex items-start justify-between mb-4">
        <h3 class="text-xl font-bold text-gray-800">D√©tails de la proposition</h3>
        <button (click)="closeSidebar()"
                class="p-1 hover:bg-gray-100 rounded transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="space-y-4">
        <!-- Statut -->
        <div>
          <span class="inline-block px-3 py-1 rounded-full text-sm font-medium border"
                [ngClass]="getStatutColor(selectedProposition()!.statut)">
            {{ getStatutLabel(selectedProposition()!.statut) }}
          </span>
        </div>

        <!-- Cours -->
        <div>
          <h4 class="text-sm font-semibold text-gray-600 mb-1">Cours</h4>
          <p class="text-gray-800 font-medium">{{ selectedProposition()!.cours.nom }}</p>
          <p class="text-sm text-gray-600 mt-1">{{ selectedProposition()!.cours.description }}</p>
          <div class="mt-2 flex flex-wrap gap-1">
            @for (competence of selectedProposition()!.cours.competencesRequises; track competence) {
              <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded">
                {{ competence }}
              </span>
            }
          </div>
        </div>

        <!-- Description -->
        <div>
          <h4 class="text-sm font-semibold text-gray-600 mb-1">Description</h4>
          <p class="text-sm text-gray-700">{{ selectedProposition()!.description }}</p>
        </div>

        <!-- √âcole -->
        <div>
          <h4 class="text-sm font-semibold text-gray-600 mb-1">√âcole</h4>
          <div class="flex items-start gap-3">
            <img [src]="getSchoolLogo(selectedProposition()!.ecole)" [alt]="selectedProposition()!.ecole.nom" class="w-12 h-12 bg-gray-100 rounded object-contain p-1" />
            <div>
              <p class="text-gray-800 font-medium">{{ selectedProposition()!.ecole.nom }}</p>
              <p class="text-sm text-gray-600">
                {{ selectedProposition()!.ecole.adresse }}<br>
                {{ selectedProposition()!.ecole.codePostal }} {{ selectedProposition()!.ecole.ville }}
              </p>
            </div>
          </div>
        </div>

        <!-- Classe -->
        <div>
          <h4 class="text-sm font-semibold text-gray-600 mb-1">Classe</h4>
          <p class="text-gray-800">{{ selectedProposition()!.classe.nom }} - {{ selectedProposition()!.classe.niveau }}</p>
          <p class="text-sm text-gray-600">{{ selectedProposition()!.classe.nombreEleves }} √©l√®ves</p>
        </div>

        <!-- Volume horaire total -->
        @if (selectedProposition()!.volumeHoraire) {
          <div>
            <h4 class="text-sm font-semibold text-gray-600 mb-1">Volume horaire total</h4>
            <p class="text-2xl font-bold text-eduka-orange">{{ selectedProposition()!.volumeHoraire }}h</p>
          </div>
        }

        <!-- Planning des sessions -->
        @if (selectedProposition()!.sessions && selectedProposition()!.sessions!.length > 0) {
          <div>
            <h4 class="text-sm font-semibold text-gray-600 mb-2 flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              Planning des sessions ({{ selectedProposition()!.sessions!.length }} sessions)
            </h4>
            <div class="bg-gray-50 rounded-lg p-3 max-h-60 overflow-y-auto">
              @for (session of selectedProposition()!.sessions; track session.numero) {
                <div class="flex items-center justify-between py-2 px-3 bg-white rounded mb-2 last:mb-0 border border-gray-200">
                  <div class="flex items-center gap-3">
                    <span class="flex items-center justify-center w-8 h-8 rounded-full bg-orange-100 text-orange-600 text-sm font-semibold">
                      {{ session.numero }}
                    </span>
                    <div>
                      <p class="font-medium text-gray-900">{{ session.dateDebut | date:'EEEE d MMMM yyyy':'':'fr' }}</p>
                      <p class="text-sm text-gray-600">{{ session.heureDebut }} - {{ session.heureFin }} ({{ session.duree }}h)</p>
                    </div>
                  </div>
                </div>
              }
            </div>
          </div>
        } @else {
          <!-- Fallback pour anciennes propositions sans sessions -->
          <div>
            <h4 class="text-sm font-semibold text-gray-600 mb-1">Date et horaires</h4>
            @if (selectedProposition()!.dateDebut) {
              <p class="text-gray-800">
                {{ selectedProposition()!.dateDebut | date:'fullDate':'':'fr-FR' }}
              </p>
            }
            @if (selectedProposition()!.heureDebut && selectedProposition()!.heureFin) {
              <p class="text-sm text-gray-600">
                De {{ selectedProposition()!.heureDebut }} √† {{ selectedProposition()!.heureFin }}
              </p>
            }
          </div>
        }

        <!-- R√©mun√©ration -->
        <div>
          <h4 class="text-sm font-semibold text-gray-600 mb-1">R√©mun√©ration</h4>
          <p class="text-2xl font-bold text-eduka-orange">{{ selectedProposition()!.remuneration }}‚Ç¨</p>
          @if (selectedProposition()!.volumeHoraire) {
            <p class="text-xs text-gray-500 mt-1">Brut pour {{ selectedProposition()!.volumeHoraire }}h de formation</p>
          } @else {
            <p class="text-xs text-gray-500 mt-1">Brut pour la journ√©e</p>
          }
        </div>

        <!-- Date d'expiration -->
        <div>
          <h4 class="text-sm font-semibold text-gray-600 mb-1">Date limite de candidature</h4>
          <p class="text-sm text-gray-700">
            {{ selectedProposition()!.dateExpiration | date:'fullDate':'':'fr-FR' }} √† {{ selectedProposition()!.dateExpiration | date:'HH:mm':'':'fr-FR' }}
          </p>
          @if (isExpired(selectedProposition()!)) {
            <p class="text-xs text-red-600 mt-1">‚ö†Ô∏è Cette proposition a expir√©</p>
          }
        </div>

        <!-- Syllabus -->
        @if (selectedProposition()!.cours.syllabus) {
          <div>
            <h4 class="text-sm font-semibold text-gray-600 mb-1">Syllabus</h4>
            <pre class="text-sm text-gray-700 whitespace-pre-wrap bg-gray-50 p-3 rounded">{{ selectedProposition()!.cours.syllabus }}</pre>
          </div>
        }

        <!-- Actions -->
        <div class="pt-4 border-t space-y-2">
          @if (hasApplied(selectedProposition()!)) {
            <button disabled
                    class="w-full px-4 py-2 bg-gray-100 text-gray-500 rounded-lg cursor-not-allowed">
              ‚úì Vous avez d√©j√† postul√©
            </button>
          } @else if (isExpired(selectedProposition()!)) {
            <button disabled
                    class="w-full px-4 py-2 bg-gray-100 text-gray-500 rounded-lg cursor-not-allowed">
              Cette proposition a expir√©
            </button>
          } @else if (selectedProposition()!.statut === StatutProposition.EN_ATTENTE) {
            <button (click)="postuler(selectedProposition()!.id)"
                    class="w-full px-4 py-2 bg-eduka-orange text-white rounded-lg hover:bg-orange-600 transition-colors">
              üìù Postuler √† cette mission
            </button>
          }
        </div>

        <!-- Candidatures (si applicable) -->
        @if (selectedProposition()!.candidatures && selectedProposition()!.candidatures!.length > 0) {
          <div>
            <h4 class="text-sm font-semibold text-gray-600 mb-2">Candidatures ({{ selectedProposition()!.candidatures!.length }})</h4>
            <div class="space-y-2">
              @for (candidature of selectedProposition()!.candidatures!; track candidature.id) {
                <div class="p-3 bg-gray-50 rounded border">
                  <p class="text-sm font-medium text-gray-800">{{ candidature.formateurNom }}</p>
                  @if (candidature.message) {
                    <p class="text-xs text-gray-600 mt-1">{{ candidature.message }}</p>
                  }
                  <p class="text-xs text-gray-500 mt-1">
                    {{ candidature.createdAt | date:'short':'':'fr-FR' }}
                  </p>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>
  }
</div>
